<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css"
integrity="sha512-M2wvCLH6DSRazYeZRIm1JnYyh22purTM+FDB5CsyxtQJYeKq83arPe5wgbNmcFXGqiSH2XR8dT/fJISVA1r/zQ=="
crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js"
integrity="sha512-lInM/apFSqyy1o6s89K4iQUKg6ppXEgsVxT35HbzUupEVRh2Eu9Wdl4tHj7dZO0s1uvplcYGmt3498TtHq+log=="
crossorigin=""></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.19.2/moment.min.js"></script>

<div id="ficha-mapa">
    <div class="inicio">Selecciona una obra para ver sus detalles.</div>
    <div class="contenido"  style="display:none">
        <i class="fa fa-arrow-left" style="position: absolute; top: 10px; right: 10px;" onclick="mapa.resetMapView()"></i>
        <h4><span class="field-titulo"></span></h4>
        <div class="field-descripcion"> </div>
        <hr />
        <table >
            <tr><th> Monto: </th> <td class="datum-value field-monto"></td></tr>
            <tr><th> Proveedor: </th> <td class="datum-value field-proveedor"></td></tr>
            <tr><th> Fuente de Financiamiento: </th> <td class="datum-value field-fuente"></td></tr>
            <tr><th> Alcalde a cargo: </th> <td class="datum-value field-alcalde"></td></tr>
        </table>
        <hr>
        <div class="vermas"> <a href="/open-contracting/ocds/#" class="ocdsrecord-permalink"> Ver más información ... </a> </div>
    </div>
</div>
<div class="map-container small-map" style="height: 400px;" id="ocmp-obras">
</div>
<script>
var initLat = 14.71888888, initLon = -90.6441666, initZoom = 11, dataURL = "/open-contracting/wp-content/plugins/wp-ocds/ocds-api.php?/records/summary";

var mapa = ObrasMapa(initLat, initLon, initZoom, dataURL, function (data) {
    var avgLon = initLon, avgLat = initLat, counter = 0;
    data = data.filter(function (element, index, array) {
        return element.data.municipalidad.toLowerCase() == "san juan sacatepequez" || element.data.municipalidad.toLowerCase() == "san juan sacatepéquez";
    });

    if (data.length==0) return [];

    data.forEach(function (element, index) {
        avgLon += +element.lon;
        avgLat += +element.lat;
    });
    avgLon = avgLon / (data.length+1);
    avgLat = avgLat / (data.length+1);

    mapa.options.center = [avgLat, avgLon];

    mapa.map.setView(new L.LatLng(avgLat, avgLon), 11);
    return data;
});

</script>
